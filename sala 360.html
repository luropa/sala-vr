<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Sala com Teclado e Pegadas</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- COMPONENTE: TELEPORTE NAS PEGADAS -->
  <script>
    AFRAME.registerComponent('gaze-teleport-jogo', {
      init: function () {
        this.el.addEventListener('mouseenter', () => {
          this.startTime = Date.now();
          this.checkGaze = setInterval(() => {
            const now = Date.now();
            if (now - this.startTime >= 2000) {
              clearInterval(this.checkGaze);
              const cameraRig = document.querySelector('#cameraRig');
              cameraRig.setAttribute('animation__moveToJogo', {
                property: 'position',
                to: '2.8 0.5 3.5',
                dur: 2000,
                easing: 'easeInOutQuad'
              });
            }
          }, 100);
        });
        this.el.addEventListener('mouseleave', () => {
          clearInterval(this.checkGaze);
        });
      }
    });
  </script>

  <!-- COMPONENTE: INTERAÇÃO COM A LOUSA -->
  <script>
    AFRAME.registerComponent('interacao-lousa', {
      init: function () {
        const teclado = document.querySelector('#teclado');
        const texto = document.querySelector('#texto-digitado');
        const imagem = document.querySelector('#imagem-ninho');

        this.el.addEventListener('mouseenter', () => {
          this.timeout = setTimeout(() => {
            texto.setAttribute('visible', true);
            imagem.setAttribute('visible', true);
            teclado.setAttribute('visible', true);
            if (teclado.children.length === 0) criarTeclado();
          }, 2000);
        });

        this.el.addEventListener('mouseleave', () => {
          clearTimeout(this.timeout);
        });
      }
    });

    // Função para criar teclado
    function criarTeclado() {
      const teclado = document.querySelector('#teclado');
      const textoDigitado = document.querySelector('#texto-digitado');
      const imagemNinho = document.querySelector('#imagem-ninho');
      const estrelaFeliz = document.querySelector('#estrela-feliz');
      const estrelaTriste = document.querySelector('#estrela-triste');

      const letras = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
      const espacamentoX = 0.4;
      const espacamentoY = 0.4;
      const startX = -6 * espacamentoX;
      const startY = 1.8;

      letras.forEach((letra, index) => {
        const linha = index < 13 ? 0 : 1;
        const col = index % 13;
        const x = startX + col * espacamentoX;
        const y = startY - linha * espacamentoY;

        const plano = document.createElement('a-plane');
        plano.setAttribute('width', 0.35);
        plano.setAttribute('height', 0.35);
        plano.setAttribute('color', "#fff");
        plano.setAttribute('opacity', 0.3);
        plano.setAttribute('position', `${x} ${y} -4.9`);
        plano.setAttribute('class', 'tecla');

        const letraText = document.createElement('a-text');
        letraText.setAttribute('value', letra);
        letraText.setAttribute('align', 'center');
        letraText.setAttribute('color', '#000');
        letraText.setAttribute('width', '2');
        letraText.setAttribute('font', 'mozillavr');
        letraText.setAttribute('position', '0 0 0.01');

        plano.appendChild(letraText);

        plano.addEventListener('click', () => {
          let textoAtual = textoDigitado.getAttribute('value');
          if (textoAtual.length < 10) {
            textoDigitado.setAttribute('value', textoAtual + letra);
          }
        });

        teclado.appendChild(plano);
      });

      // Botão Apagar
      const btnApagar = document.createElement('a-plane');
      btnApagar.setAttribute('position', '1.5 0.9 -4.9');
      btnApagar.setAttribute('width', 0.8);
      btnApagar.setAttribute('height', 0.4);
      btnApagar.setAttribute('color', '#fff');
      btnApagar.setAttribute('opacity', 0.3);

      const txtApagar = document.createElement('a-text');
      txtApagar.setAttribute('value', 'Apagar');
      txtApagar.setAttribute('align', 'center');
      txtApagar.setAttribute('color', '#000');
      txtApagar.setAttribute('font', 'mozillavr');
      txtApagar.setAttribute('position', '0 0 0.01');

      btnApagar.appendChild(txtApagar);
      btnApagar.addEventListener('click', () => {
        let textoAtual = textoDigitado.getAttribute('value');
        textoDigitado.setAttribute('value', textoAtual.slice(0, -1));
      });
      teclado.appendChild(btnApagar);

      // Botão Entrar
      const btnEntrar = document.createElement('a-plane');
      btnEntrar.setAttribute('position', '2.5 0.9 -4.9');
      btnEntrar.setAttribute('width', 0.8);
      btnEntrar.setAttribute('height', 0.4);
      btnEntrar.setAttribute('color', '#fff');
      btnEntrar.setAttribute('opacity', 0.3);

      const txtEntrar = document.createElement('a-text');
      txtEntrar.setAttribute('value', 'Entrar');
      txtEntrar.setAttribute('align', 'center');
      txtEntrar.setAttribute('color', '#000');
      txtEntrar.setAttribute('font', 'mozillavr');
      txtEntrar.setAttribute('position', '0 0 0.01');

      btnEntrar.appendChild(txtEntrar);
      btnEntrar.addEventListener('click', () => {
        const palavra = textoDigitado.getAttribute('value').toLowerCase();
        teclado.setAttribute('visible', false);
        textoDigitado.setAttribute('visible', false);
        imagemNinho.setAttribute('visible', false);

        if (palavra === 'ninho') {
          estrelaFeliz.setAttribute('visible', true);
          setTimeout(() => estrelaFeliz.setAttribute('visible', false), 3000);
        } else {
          estrelaTriste.setAttribute('visible', true);
          setTimeout(() => {
            estrelaTriste.setAttribute('visible', false);
            teclado.setAttribute('visible', true);
            textoDigitado.setAttribute('visible', true);
            imagemNinho.setAttribute('visible', true);
          }, 3000);
        }

        textoDigitado.setAttribute('value', '');
      });

      teclado.appendChild(btnEntrar);
    }
  </script>

  <!-- BLOQUEAR CÂMERA A NO MÁXIMO 4M DA LOUSA -->
  <script>
    AFRAME.registerComponent('barreira-lousa', {
      tick: function () {
        const cameraRig = document.querySelector('#cameraRig');
        const pos = cameraRig.object3D.position;
        const distanciaZ = Math.abs(pos.z + 4.9);
        if (distanciaZ < 0.1) return; // tolerância

        if (distanciaZ < 0.01) return;
        if (pos.z < -4.9) {
          pos.z = -4.9;
        } else if (pos.z > -0.9) {
          pos.z = -0.9;
        }
      }
    });
  </script>
</head>

<body>
  <a-scene>

    <a-assets>
      <img id="img-ninho" src="palavraninho.png" />
      <img id="img-estrela" src="estrelacontente.png" />
      <img id="img-estrela-triste" src="estrelatriste.png" />
      <img id="jogo" src="jogo-da-velha-feltro2.png" />
    </a-assets>

    <!-- LUZ E FUNDO -->
    <a-light type="ambient" color="#ffffff" intensity="1.2"></a-light>
    <a-plane src="piso1.png" width="10" height="10" rotation="-90 0 0" class="piso" material="shader: flat;"></a-plane>
    <a-plane color="#a9c9dd" width="10" height="10" position="0 5 0" rotation="90 0 0"></a-plane>

    <!-- PAREDES -->
    <a-plane width="10" height="5" position="0 2.5 -5" material="color: #ccc"></a-plane>
    <a-plane width="10" height="5" position="0 2.5 5" rotation="0 180 0" material="color: #ccc"></a-plane>
    <a-plane width="10" height="5" position="-5 2.5 0" rotation="0 90 0" material="color: #ccc"></a-plane>
    <a-plane width="10" height="5" position="5 2.5 0" rotation="0 -90 0" material="color: #ccc"></a-plane>

    <!-- LOUSA -->
    <a-image
      id="lousa"
      src="lousaembranco2.png"
      position="0 2.5 -4.95"
      width="5.6"
      height="3.1"
      interacao-lousa
    ></a-image>

    <!-- IMAGENS E TEXTOS -->
    <a-image id="imagem-ninho" src="#img-ninho" position="0 3 -4.9" width="1" height="0.5" visible="false"></a-image>
    <a-image id="estrela-feliz" src="#img-estrela" position="0 2.5 -4.9" width="1" height="1" visible="false"></a-image>
    <a-image id="estrela-triste" src="#img-estrela-triste" position="0 2.5 -4.9" width="1" height="1" visible="false"></a-image>

    <a-text
      id="texto-digitado"
      value=""
      position="0 2.5 -4.9"
      color="#000"
      align="center"
      width="3"
      font="mozillavr"
      visible="false"
    ></a-text>

    <!-- TECLADO -->
    <a-entity id="teclado" visible="false"></a-entity>

    <!-- PEGADAS -->
    <a-image src="pegadas.png" width="0.8" height="0.8" rotation="-90 180 0" position="2.7 0.01 4" gaze-teleport-jogo></a-image>

    <!-- CÂMERA E CONTROLE -->
    <a-entity id="cameraRig" position="0 0.5 0" barreira-lousa>
      <a-camera look-controls>
        <a-cursor
          fuse="true"
          fuse-timeout="2000"
          color="red"
          geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
          material="color: red; shader: flat"
          position="0 0 -1"
        ></a-cursor>
      </a-camera>
    </a-entity>

    <a-entity id="teleportRig" position="0 0 0">
      <a-entity laser-controls="hand: right"></a-entity>
      <a-entity teleport-controls="cameraRig: #cameraRig; button: trigger; collisionEntities: .piso;"></a-entity>
    </a-entity>
  </a-scene>
</body>
</html>
