<script>
  AFRAME.registerComponent('gaze-move-controller', {
    schema: { speed: { type: 'number', default: 1.5 } },
    init: function () {
      this.direction = new THREE.Vector3();
      this.moving = false;
      this.cameraEl = this.el.querySelector('a-camera');
      this.aproximado = false; // trava a aproximação após chegar a 1.5m
    },
    tick: function (time, deltaTime) {
      if (!this.moving || this.aproximado) return;

      const rig = this.el;
      const lousa = document.querySelector('#lousa');

      const camPos = rig.object3D.position;
      const lousaPos = lousa.object3D.position;

      this.cameraEl.object3D.getWorldDirection(this.direction);
      this.direction.y = 0;
      this.direction.normalize();

      const dx = camPos.x - lousaPos.x;
      const dz = camPos.z - lousaPos.z;
      const distXZ = Math.sqrt(dx * dx + dz * dz);

      const limiteDistancia = 1.5; // 1,5 metros

      if (distXZ > limiteDistancia) {
        const delta = this.data.speed * (deltaTime / 1000);
        const moveVector = this.direction.clone().multiplyScalar(-delta);

        const novaX = camPos.x + moveVector.x;
        const novaZ = camPos.z + moveVector.z;

        const novaDistXZ = Math.sqrt(
          (novaX - lousaPos.x) * (novaX - lousaPos.x) +
          (novaZ - lousaPos.z) * (novaZ - lousaPos.z)
        );

        if (novaDistXZ <= limiteDistancia) {
          const dirParaLousa = new THREE.Vector3(
            lousaPos.x - camPos.x,
            0,
            lousaPos.z - camPos.z
          ).normalize();

          rig.object3D.position.x = lousaPos.x - dirParaLousa.x * limiteDistancia;
          rig.object3D.position.z = lousaPos.z - dirParaLousa.z * limiteDistancia;

          this.aproximado = true;
        } else {
          rig.object3D.position.x = novaX;
          rig.object3D.position.z = novaZ;
        }
      }
    }
  });
</script>
