<!DOCTYPE html>
<html lang="pt-br">
<head> 
  <meta charset="utf-8" />
  <title>Sala de Estudo com Teclado Virtual e Movimento por Gaze para VR</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
</head>
<body>
  <a-scene background="color: #a0c8f0">

    <a-assets>
      <a-asset-item id="modeloCadeira" src="cadeira_final.glb"></a-asset-item>
      <img id="img-ninho" src="palavraninho.png" />
      <img id="img-estrela" src="estrelacontente.png" />
      <img id="img-estrela-triste" src="estrelatriste.png" />
      <img id="jogo" src="jogo-da-velha-feltro2.png" />
    </a-assets>

    <a-light type="ambient" color="#ffffff" intensity="1.2"></a-light>

    <!-- Piso e teto -->
    <a-plane src="piso1.png" width="10" height="10" rotation="-90 0 0"></a-plane>
    <a-plane color="#a9c9dd" width="10" height="10" position="0 5 0" rotation="90 0 0"></a-plane>

    <!-- Paredes -->
    <a-plane width="10" height="5" position="0 2.5 -5" material="src: paredeerodape2.png;"></a-plane>
    <a-plane width="10" height="5" position="0 2.5 5" rotation="0 180 0" material="src: paredeerodape2.png;"></a-plane>
    <a-plane width="10" height="5" position="-5 2.5 0" rotation="0 90 0" material="src: paredeerodape2.png;"></a-plane>
    <a-plane width="10" height="5" position="5 2.5 0" rotation="0 -90 0" material="src: paredeerodape2.png;"></a-plane>

    <!-- Lousa -->
    <a-image id="lousa" interacao-lousa src="lousaembranco2.png" width="5.6" height="3.1" position="0 2.5 -4.95"></a-image>

    <!-- Palavra e texto -->
    <a-image id="imagem-ninho" src="#img-ninho" width="1" height="0.5" position="0 3 -4.9" visible="false"></a-image>
    <a-text id="texto-digitado" value="" position="0 2.5 -4.9" color="#000" align="center" width="3" visible="false"></a-text>

    <!-- Teclado -->
    <a-entity id="teclado" visible="false"></a-entity>

    <!-- Pegadas visíveis -->
    <a-image src="pegadas.png" width="0.8" height="0.8" rotation="-90 180 0" position="2.7 0.01 4"></a-image>

    <!-- Plano invisível para gaze (área para teletransporte) -->
    <a-plane id="teleportArea" width="0.8" height="0.8" rotation="-90 180 0" position="2.7 0.02 4" material="opacity: 0; transparent: true"></a-plane>

    <!-- Outras pegadas -->
    <a-image src="pegadas.png" width="0.8" height="0.8" rotation="-90 90 0" position="0 0.01 0.5"></a-image>

    <!-- Usuário -->
    <a-entity id="cameraRig" position="0 0.5 0.5" rotation="0 90 0">
      <a-camera look-controls wasd-controls-enabled="false">
        <!-- Cursor não usado pois gaze será manual -->
      </a-camera>
    </a-entity>

  </a-scene>

  <script>
    AFRAME.registerComponent('gaze-teleport', {
      schema: {
        timeout: { type: 'number', default: 2000 } // tempo em ms para teletransporte
      },
      init: function () {
        this.gazeTimer = null;
        this.isGazing = false;
        this.camera = document.querySelector('a-camera');
        this.rig = document.querySelector('#cameraRig');

        // Raycaster para detectar o que a câmera está olhando
        this.raycaster = new THREE.Raycaster();

        this.tick = AFRAME.utils.throttleTick(this.tick.bind(this), 100);
      },
      tick: function (time, delta) {
        if (!this.camera) return;

        // Posição e direção da câmera
        const cameraObj = this.camera.object3D;
        const origin = new THREE.Vector3();
        const direction = new THREE.Vector3(0, 0, -1);
        origin.setFromMatrixPosition(cameraObj.matrixWorld);
        direction.applyQuaternion(cameraObj.quaternion);

        // Raycast para o teleportArea
        this.raycaster.set(origin, direction);
        const teleportArea = document.querySelector('#teleportArea').object3D;
        const intersects = this.raycaster.intersectObject(teleportArea, false);

        if (intersects.length > 0) {
          if (!this.isGazing) {
            this.isGazing = true;
            this.gazeTimer = setTimeout(() => {
              // Teletransporte para frente da lousa
              this.rig.setAttribute('position', '0 0.5 -3');
              this.rig.setAttribute('rotation', '0 0 0');
              console.log('Teletransporte realizado!');
              this.isGazing = false;
            }, this.data.timeout);
          }
        } else {
          this.isGazing = false;
          if (this.gazeTimer) {
            clearTimeout(this.gazeTimer);
            this.gazeTimer = null;
          }
        }
      }
    });

    // Ativa o componente no scene
    document.querySelector('a-scene').setAttribute('gaze-teleport', '');

    // Seu componente de interação com a lousa e teclado segue igual ao original:

    const lousa = document.querySelector('#lousa');
    const imagem = document.querySelector('#imagem-ninho');
    const teclado = document.querySelector('#teclado');
    const textoDigitado = document.querySelector('#texto-digitado');
    const tamanhoOriginal = { width: 1, height: 0.5 };
    let tecladoCriado = false;
    let finalizou = false;

    AFRAME.registerComponent('interacao-lousa', {
      init: function () {
        this.el.addEventListener('mouseenter', () => {
          if(finalizou) return;
          this.timeout = setTimeout(() => {
            imagem.setAttribute('visible', true);
            textoDigitado.setAttribute('visible', true);
            textoDigitado.setAttribute('value', '');
            imagem.setAttribute('src', '#img-ninho');
            imagem.setAttribute('width', tamanhoOriginal.width.toString());
            imagem.setAttribute('height', tamanhoOriginal.height.toString());
            imagem.setAttribute('position', '0 3 -4.9');
            if (!tecladoCriado) { criarTeclado(); tecladoCriado = true; }
            teclado.setAttribute('visible', true);
          }, 2000);
        });
        this.el.addEventListener('mouseleave', () => { clearTimeout(this.timeout); });
      }
    });

    function criarTeclado() {
      const letras = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
      const espacamentoX = 0.3, espacamentoY = 0.3, startX = -6 * espacamentoX, startY = 1.9;
      letras.forEach((letra, index) => {
        const linha = index < 13 ? 0 : 1;
        const col = index % 13;
        const x = startX + col * espacamentoX;
        const y = startY - linha * espacamentoY;
        const plano = document.createElement('a-plane');
        plano.setAttribute('width', 0.35);
        plano.setAttribute('height', 0.35);
        plano.setAttribute('color', '#ffffff');
        plano.setAttribute('opacity', 0.2);
        plano.setAttribute('position', `${x} ${y} -4.9`);
        const letraText = document.createElement('a-text');
        letraText.setAttribute('value', letra);
        letraText.setAttribute('color', '#000');
        letraText.setAttribute('align', 'center');
        letraText.setAttribute('width', '2');
        letraText.setAttribute('position', '0 0 0.02');
        plano.appendChild(letraText);
        plano.addEventListener('click', () => {
          if(finalizou) return;
          let textoAtual = textoDigitado.getAttribute('value');
          if (!textoAtual.endsWith(letra)) textoDigitado.setAttribute('value', textoAtual + letra);
        });
        teclado.appendChild(plano);
      });
      criarBotaoExtra('Apagar', -1, startY - 2 * espacamentoY, () => {
        if(finalizou) return;
        let textoAtual = textoDigitado.getAttribute('value');
        textoDigitado.setAttribute('value', textoAtual.slice(0, -1));
      }, '#ffffff', 0.2);
      criarBotaoExtra('Entrar', 1, startY - 2 * espacamentoY, () => {
        if(finalizou) return;
        const texto = textoDigitado.getAttribute('value').trim().toUpperCase();
        if (texto === 'NINHO') {
          imagem.setAttribute('src', '#img-estrela');
          imagem.setAttribute('width', '0.8');
          imagem.setAttribute('height', '1.2');
          imagem.setAttribute('position', '0 3 -4.8');
          textoDigitado.setAttribute('visible', false);
          teclado.setAttribute('visible', false);
          finalizou = true;
        } else {
          imagem.setAttribute('src', '#img-estrela-triste');
          imagem.setAttribute('material', 'transparent: true');
          imagem.setAttribute('width', '1.7');
          imagem.setAttribute('height', '1.5');
          imagem.setAttribute('position', '0 3 -4.8');
          textoDigitado.setAttribute('visible', false);
          setTimeout(() => {
            imagem.setAttribute('src', '#img-ninho');
            imagem.setAttribute('width', tamanhoOriginal.width.toString());
            imagem.setAttribute('height', tamanhoOriginal.height.toString());
            imagem.setAttribute('position', '0 3 -4.9');
            textoDigitado.setAttribute('value', '');
            textoDigitado.setAttribute('visible', true);
            teclado.setAttribute('visible', true);
          }, 3000);
        }
      }, '#ffffff', 0.2);
    }

    function criarBotaoExtra(texto, x, y, callback, cor, opacidade) {
      const plano = document.createElement('a-plane');
      plano.setAttribute('width', 1);
      plano.setAttribute('height', 0.3);
      plano.setAttribute('color', cor);
      plano.setAttribute('opacity', opacidade);
      plano.setAttribute('position', `${x} ${y} -4.9`);
      const textoEntity = document.createElement('a-text');
      textoEntity.setAttribute('value', texto);
      textoEntity.setAttribute('align', 'center');
      textoEntity.setAttribute('color', '#000');
      textoEntity.setAttribute('width', '2');
      textoEntity.setAttribute('position', '0 0 0.02');
      plano.appendChild(textoEntity);
      plano.addEventListener('click', callback);
      teclado.appendChild(plano);
    }
  </script>
</body>
</html>
